L.Draw.Polyline=L.Draw.Feature.extend({statics:{TYPE:'polyline'},Poly:L.Polyline,options:{allowIntersection:true,repeatMode:false,drawError:{color:'#b00b00',timeout:2500},icon:new L.DivIcon({iconSize:new L.Point(10,10),className:'leaflet-div-icon leaflet-editing-icon'}),guidelineDistance:20,maxGuideLineLength:4000,shapeOptions:{stroke:true,color:'#f06eaa',weight:4,opacity:0.5,fill:false,clickable:true},metric:true,zIndexOffset:2000},initialize:function(map,options){if(options&&options.drawError){options.drawError=L.Util.extend({},this.options.drawError,options.drawError);} this.type=L.Draw.Polyline.TYPE;L.Draw.Feature.prototype.initialize.call(this,map,options);},addHooks:function(){L.Draw.Feature.prototype.addHooks.call(this);if(this._map){this._markers=[];this._markerGroup=new L.LayerGroup();this._map.addLayer(this._markerGroup);this._poly=new L.Polyline([],this.options.shapeOptions);if(!this._mouseMarker){this._mouseMarker=L.marker(this._map.getCenter(),{icon:L.divIcon({className:'leaflet-mouse-marker',iconAnchor:[20,20],iconSize:[40,40]}),opacity:0,zIndexOffset:this.options.zIndexOffset});} this._mouseMarker.on('mousedown',this._onMouseDown,this).addTo(this._map);this._map.on('mousemove',this._onMouseMove,this).on('mouseup',this._onMouseUp,this).on('zoomend',this._onZoomEnd,this);}},removeHooks:function(){L.Draw.Feature.prototype.removeHooks.call(this);this._clearHideErrorTimeout();this._cleanUpShape();this._map.removeLayer(this._markerGroup);delete this._markerGroup;delete this._markers;this._map.removeLayer(this._poly);delete this._poly;this._mouseMarker.off('mousedown',this._onMouseDown,this).off('mouseup',this._onMouseUp,this);this._map.removeLayer(this._mouseMarker);delete this._mouseMarker;this._clearGuides();this._map.off('mousemove',this._onMouseMove,this).off('zoomend',this._onZoomEnd,this);},deleteLastVertex:function(){if(this._markers.length<=1){return;} var lastMarker=this._markers.pop(),poly=this._poly,latlng=this._poly.spliceLatLngs(poly.getLatLngs().length-1,1)[0];this._markerGroup.removeLayer(lastMarker);if(poly.getLatLngs().length<2){this._map.removeLayer(poly);} this._vertexChanged(latlng,false);},addVertex:function(latlng){this._markers.push(this._createMarker(latlng));this._poly.addLatLng(latlng);if(this._poly.getLatLngs().length===2){this._map.addLayer(this._poly);} this._vertexChanged(latlng,true);},_finishShape:function(){this._fireCreatedEvent();this.disable();if(this.options.repeatMode){this.enable();}},_shapeIsValid:function(){return true;},_onZoomEnd:function(){this._updateGuide();},_onMouseMove:function(e){var newPos=e.layerPoint,latlng=e.latlng;this._currentLatLng=latlng;this._updateGuide(newPos);this._mouseMarker.setLatLng(latlng);L.DomEvent.preventDefault(e.originalEvent);},_vertexChanged:function(){this._updateFinishHandler();this._clearGuides();},_onMouseDown:function(e){var originalEvent=e.originalEvent;this._mouseDownOrigin=L.point(originalEvent.clientX,originalEvent.clientY);},_onMouseUp:function(e){if(this._mouseDownOrigin){var distance=L.point(e.originalEvent.clientX,e.originalEvent.clientY).distanceTo(this._mouseDownOrigin);if(Math.abs(distance)<9*(window.devicePixelRatio||1)){this.addVertex(e.latlng);}} this._mouseDownOrigin=null;},_updateFinishHandler:function(){var markerCount=this._markers.length;if(markerCount>1){this._markers[markerCount-1].on('click',this._finishShape,this);} if(markerCount>2){this._markers[markerCount-2].off('click',this._finishShape,this);}},_createMarker:function(latlng){var marker=new L.Marker(latlng,{icon:this.options.icon,zIndexOffset:this.options.zIndexOffset*2});this._markerGroup.addLayer(marker);return marker;},_updateGuide:function(newPos){var markerCount=this._markers.length;if(markerCount>0){newPos=newPos||this._map.latLngToLayerPoint(this._currentLatLng);this._clearGuides();this._drawGuide(this._map.latLngToLayerPoint(this._markers[markerCount-1].getLatLng()),newPos);}},_drawGuide:function(pointA,pointB){var length=Math.floor(Math.sqrt(Math.pow((pointB.x-pointA.x),2)+Math.pow((pointB.y-pointA.y),2))),guidelineDistance=this.options.guidelineDistance,maxGuideLineLength=this.options.maxGuideLineLength,i=length>maxGuideLineLength?length-maxGuideLineLength:guidelineDistance,fraction,dashPoint,dash;if(!this._guidesContainer){this._guidesContainer=L.DomUtil.create('div','leaflet-draw-guides',this._overlayPane);} for(;i<length;i+=this.options.guidelineDistance){fraction=i/length;dashPoint={x:Math.floor((pointA.x*(1-fraction))+(fraction*pointB.x)),y:Math.floor((pointA.y*(1-fraction))+(fraction*pointB.y))};dash=L.DomUtil.create('div','leaflet-draw-guide-dash',this._guidesContainer);dash.style.backgroundColor=!this._errorShown?this.options.shapeOptions.color:this.options.drawError.color;L.DomUtil.setPosition(dash,dashPoint);}},_updateGuideColor:function(color){if(this._guidesContainer){for(var i=0,l=this._guidesContainer.childNodes.length;i<l;i++){this._guidesContainer.childNodes[i].style.backgroundColor=color;}}},_clearGuides:function(){if(this._guidesContainer){while(this._guidesContainer.firstChild){this._guidesContainer.removeChild(this._guidesContainer.firstChild);}}},_clearHideErrorTimeout:function(){if(this._hideErrorTimeout){clearTimeout(this._hideErrorTimeout);this._hideErrorTimeout=null;}},_cleanUpShape:function(){if(this._markers.length>1){this._markers[this._markers.length-1].off('click',this._finishShape,this);}},_fireCreatedEvent:function(){var poly=new this.Poly(this._poly.getLatLngs(),this.options.shapeOptions);L.Draw.Feature.prototype._fireCreatedEvent.call(this,poly);}});